name: Upload Products (Manual)

on:
  workflow_dispatch:
    inputs:
      sets:
        description: 'Set codes (comma-separated, e.g., sv6,sv7 or just sma)'
        required: true
        default: 'sma'
      min_price:
        description: 'Minimum price in CAD (e.g., 5)'
        required: true
        default: '5'

jobs:
  upload-products:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests psycopg2-binary python-dotenv
      
      - name: Run product upload script
        env:
          # Database
          NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
          
          # Shopify
          SHOPIFY_SHOP_URL: ${{ secrets.SHOPIFY_SHOP_URL }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          SHOPIFY_LOCATION_ID: ${{ secrets.SHOPIFY_LOCATION_ID }}
          SHOPIFY_API_VERSION: '2025-01'
          
          # PokemonTCG API
          POKEMONTCG_API_URL: 'https://api.pokemontcg.io/v2'
          TCG_API_KEY: ${{ secrets.TCG_API_KEY }}
          
          # Pricing
          USD_TO_CAD: '1.35'
          MARKUP: '1.10'
          MIN_PRICE_CAD: ${{ github.event.inputs.min_price }}
          
          # CRITICAL FIX: Pass sets via environment variable
          SETS_TO_UPLOAD: ${{ github.event.inputs.sets }}
        run: |
          echo "Starting product upload..."
          echo "Sets to upload: ${{ github.event.inputs.sets }}"
          echo "Minimum price: ${{ github.event.inputs.min_price }}"
          
          # Run the script (it will read SETS_TO_UPLOAD from environment)
          python bulk_upload_corrected.py
